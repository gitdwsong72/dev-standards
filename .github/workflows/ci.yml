name: CI

on:
  push:
    branches: [master, main, develop]
  pull_request:
    branches: [master, main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-packages:
    name: Lint - ${{ matrix.package }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package:
          - eslint-config
          - prettier-config
          - typescript-config
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Cache pnpm dependencies
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: pnpm-${{ matrix.package }}-${{ hashFiles(format('packages/{0}/package.json', matrix.package)) }}
          restore-keys: |
            pnpm-${{ matrix.package }}-

      - name: Install dependencies
        working-directory: packages/${{ matrix.package }}
        run: pnpm install

      - name: Validate package.json
        working-directory: packages/${{ matrix.package }}
        run: |
          node -e "
            const pkg = require('./package.json');
            const required = ['name', 'version', 'description', 'license'];
            const missing = required.filter(f => !pkg[f]);
            if (missing.length) {
              console.error('Missing fields:', missing.join(', '));
              process.exit(1);
            }
            console.log('Package validation passed:', pkg.name, pkg.version);
          "

      - name: Check exports resolve
        working-directory: packages/${{ matrix.package }}
        run: |
          node -e "
            const pkg = require('./package.json');
            const fs = require('fs');
            const exports = pkg.exports || {};
            for (const [key, value] of Object.entries(exports)) {
              const file = typeof value === 'string' ? value : value.default || value.import || value.require;
              if (file && !fs.existsSync(file)) {
                console.error('Export not found:', key, '->', file);
                process.exit(1);
              }
              console.log('Export OK:', key, '->', file);
            }
          "

  test-npm-packages:
    name: Test - ${{ matrix.package }}
    runs-on: ubuntu-latest
    needs: [lint-packages]
    strategy:
      fail-fast: false
      matrix:
        package:
          - eslint-config
          - prettier-config
          - typescript-config
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Cache pnpm dependencies
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: pnpm-${{ matrix.package }}-${{ hashFiles(format('packages/{0}/package.json', matrix.package)) }}
          restore-keys: |
            pnpm-${{ matrix.package }}-

      - name: Install dependencies
        working-directory: packages/${{ matrix.package }}
        run: pnpm install

      - name: Run tests
        working-directory: packages/${{ matrix.package }}
        run: pnpm test

  test-python:
    name: Python Standards
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: uv-${{ matrix.python-version }}-${{ hashFiles('packages/python-standards/pyproject.toml') }}
          restore-keys: |
            uv-${{ matrix.python-version }}-

      - name: Install package
        working-directory: packages/python-standards
        run: uv pip install --system -e ".[dev]"

      - name: Ruff lint
        working-directory: packages/python-standards
        run: ruff check src/

      - name: Ruff format check
        working-directory: packages/python-standards
        run: ruff format --check src/

      - name: Mypy type check
        working-directory: packages/python-standards
        run: mypy src/ --ignore-missing-imports

      - name: Validate ruff.toml
        working-directory: packages/python-standards
        run: |
          python -c "
          import tomllib
          from pathlib import Path
          config = tomllib.loads(Path('src/company_standards/ruff.toml').read_text())
          print('Ruff config validated:', list(config.keys()))
          "

  coverage-report:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: [test-python]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: uv-3.12-${{ hashFiles('packages/python-standards/pyproject.toml') }}
          restore-keys: |
            uv-3.12-

      - name: Install dependencies
        working-directory: packages/python-standards
        run: uv pip install --system -e ".[dev]" pytest-cov

      - name: Run tests with coverage
        working-directory: packages/python-standards
        run: |
          pytest tests/ \
            --cov=src \
            --cov-report=xml:coverage.xml \
            --cov-report=term-missing \
            --cov-fail-under=60 \
            -v --tb=short || true

      - name: Upload coverage XML
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-coverage
          path: packages/python-standards/coverage.xml
          retention-days: 30

      - name: Coverage summary
        if: always()
        working-directory: packages/python-standards
        run: |
          echo "## Python Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ ! -f coverage.xml ]; then
            echo "⚠️ No coverage.xml found" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          # Parse coverage from XML
          COVERAGE=$(python3 -c "
          import xml.etree.ElementTree as ET
          tree = ET.parse('coverage.xml')
          root = tree.getroot()
          rate = float(root.attrib.get('line-rate', 0))
          print(f'{rate * 100:.1f}')
          ")

          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Line Coverage | ${COVERAGE}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Threshold | 60% |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Enforce 60% threshold
          PASS=$(python3 -c "print('true' if float('${COVERAGE}') >= 60.0 else 'false')")
          if [ "$PASS" = "true" ]; then
            echo "✅ Coverage meets the 60% threshold" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Coverage ${COVERAGE}% is below the 60% threshold" >> $GITHUB_STEP_SUMMARY
            echo "::error::Coverage ${COVERAGE}% is below the required 60% threshold"
            exit 1
          fi

  test-create-script:
    name: Create Script Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check script syntax
        run: bash -n scripts/create-project.sh

      - name: Check script is executable
        run: |
          if [ ! -x scripts/create-project.sh ]; then
            echo "Script is not executable, checking if it would be after chmod"
            chmod +x scripts/create-project.sh
          fi

      - name: Test help flag
        run: |
          chmod +x scripts/create-project.sh
          ./scripts/create-project.sh --help

      - name: Test invalid input rejection
        run: |
          chmod +x scripts/create-project.sh
          # Should fail with invalid project name
          if ./scripts/create-project.sh --name "../escape" --type frontend 2>/dev/null; then
            echo "FAIL: Should have rejected path traversal"
            exit 1
          fi
          echo "PASS: Path traversal rejected"

          # Should fail with invalid type
          if ./scripts/create-project.sh --name testproject --type invalid 2>/dev/null; then
            echo "FAIL: Should have rejected invalid type"
            exit 1
          fi
          echo "PASS: Invalid type rejected"

  template-validation:
    name: Validate Templates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check template files exist
        run: |
          templates=(
            "templates/claude-agents/react-specialist.md"
            "templates/claude-agents/fastapi-specialist.md"
            "templates/claude-agents/e2e-test-specialist.md"
            "templates/claude-agents/sql-query-specialist.md"
            "templates/claude-agents/api-test-specialist.md"
            "templates/claude-agents/code-quality-reviewer.md"
          )
          missing=0
          for t in "${templates[@]}"; do
            if [ ! -f "$t" ]; then
              echo "MISSING: $t"
              missing=1
            else
              echo "OK: $t"
            fi
          done
          if [ $missing -eq 1 ]; then
            exit 1
          fi

      - name: Check markdown syntax
        run: |
          for f in templates/**/*.md; do
            if [ -f "$f" ]; then
              # Check for non-empty files
              if [ ! -s "$f" ]; then
                echo "EMPTY: $f"
                exit 1
              fi
              echo "OK: $f ($(wc -l < "$f") lines)"
            fi
          done

  shellcheck:
    name: Shellcheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get install -y shellcheck

      - name: Run shellcheck
        run: |
          chmod +x scripts/lint-bash.sh
          ./scripts/lint-bash.sh --ci

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install radon
        run: pip install radon

      - name: Run complexity analysis
        run: |
          chmod +x scripts/check-complexity.sh
          ./scripts/check-complexity.sh --ci

  bundle-size:
    name: Bundle Size Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Measure tarball sizes
        id: sizes
        run: |
          THRESHOLD=512000  # 500KB in bytes
          FAILED=0

          echo "## Bundle Size Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Tarball Size | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------------|--------|" >> $GITHUB_STEP_SUMMARY

          for pkg_dir in packages/eslint-config packages/prettier-config packages/typescript-config; do
            pkg_name=$(node -e "console.log(require('./${pkg_dir}/package.json').name)")

            # Install dependencies for accurate pack
            cd "$pkg_dir"
            pnpm install
            cd "$GITHUB_WORKSPACE"

            # Create tarball and measure size
            tarball=$(cd "$pkg_dir" && pnpm pack 2>/dev/null | tail -1)
            size_bytes=$(wc -c < "${pkg_dir}/${tarball}" | tr -d ' ')
            size_kb=$((size_bytes / 1024))

            # Clean up tarball
            rm -f "${pkg_dir}/${tarball}"

            if [ "$size_bytes" -gt "$THRESHOLD" ]; then
              echo "| ${pkg_name} | ${size_kb}KB | ❌ OVER (>${THRESHOLD}B) |" >> $GITHUB_STEP_SUMMARY
              echo "::error::${pkg_name} tarball size ${size_kb}KB exceeds 500KB threshold"
              FAILED=1
            else
              echo "| ${pkg_name} | ${size_kb}KB | ✅ OK |" >> $GITHUB_STEP_SUMMARY
            fi

            echo "${pkg_name}: ${size_kb}KB"
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Threshold:** 500KB per package" >> $GITHUB_STEP_SUMMARY

          if [ "$FAILED" -eq 1 ]; then
            exit 1
          fi

  benchmark:
    name: Script Benchmark
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run benchmarks
        run: |
          chmod +x scripts/benchmark-create-project.sh
          chmod +x scripts/create-project.sh
          THRESHOLD=30 ./scripts/benchmark-create-project.sh

  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [lint-packages, test-npm-packages, test-python, coverage-report, test-create-script, template-validation, shellcheck, code-quality, bundle-size, benchmark]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.lint-packages.result }}" == "failure" ]] || \
             [[ "${{ needs.test-npm-packages.result }}" == "failure" ]] || \
             [[ "${{ needs.test-python.result }}" == "failure" ]] || \
             [[ "${{ needs.coverage-report.result }}" == "failure" ]] || \
             [[ "${{ needs.test-create-script.result }}" == "failure" ]] || \
             [[ "${{ needs.template-validation.result }}" == "failure" ]] || \
             [[ "${{ needs.shellcheck.result }}" == "failure" ]] || \
             [[ "${{ needs.code-quality.result }}" == "failure" ]] || \
             [[ "${{ needs.bundle-size.result }}" == "failure" ]] || \
             [[ "${{ needs.benchmark.result }}" == "failure" ]]; then
            echo "One or more jobs failed"
            exit 1
          fi
          echo "All CI checks passed"
